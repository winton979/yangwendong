<!DOCTYPE html>
<html class="desktop">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>平安填充</title>
    <meta name="keywords" content=""/>
    <meta name="renderer" content="webkit">
    <meta name="description" content="测试"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="doT.js"></script>
    
    <style type="text/css">
		#myDataTable {
			background-color: white;
			position: fixed;
			right: 5px;
			width: 240px;
			bottom: 45px;
			border: 1px solid #b9b9b9;
			padding: 3px;
		}
		
		#containerDivID {
			margin-top: 3px;
			padding: 3px;
			height: 500px;
			border: 1px solid #b9b9b9;
			overflow: hidden;
		}
</style>
</head>

<body>
	
	<div id="pinganView">
		<iframe id ="testIfame" name="testIfame" src ="https://fls-aflm.pingan.com.cn/pazl-web/app/login.html" height="850px%" width="100%"></iframe>
		
		<div id="myDataTable">
			<div id="showDivID" class="FILL_PLUGIN_enable">
				<div id="toolbarDivID">
					<div id="messageArea" style="color: red"></div>
				</div>
				
				<!-- 查询框 -->
				<div id="searchDivID">
					客户姓名 : <input id="queryNane" name="queryNane" style="width: 150px"><br>
					客户电话 : <input id="queryMobile" name="queryMobile" style="width: 150px"><br>
					<input id="searchBtnID" type="button" value="查询">
					<button id="colseLoginIframe" onclick="javascript:colseLoginIframe()">关闭平安登录窗口</button>
					<button id="colseLoginIframe" onclick="javascript:refreshIframe()">刷新</button>
				</div>
				
				<!-- 结果集 -->
				<div id="containerDivID">
					<div style="height:100%;width:100%;overflow:auto" id="userInfoView">
					</div>
				</div>
				<input id="modelFlag" type="hidden" value="1">
			</div>
			<button onclick="javascript:onModel()">平安填充插件最小化</button>
		</div>
	</div>
		
	<!-- 登入界面  -->
	<div id="loginIfameView"></div>
</body>
<script type="text/x-dot-template" id="userInfo">
<table border="1" style="width: 100%" cellspacing="0">
	<thead align="center">
		<tr>
			<th>操作</th>
			<th>客户名称</th>
			<th>客户电话</th>
		</tr>
	</thead>
	
	<tbody align="center">

	{{ for (var i = 0, l = it.length; i < l; i++) { }}
		<tr>
			<td><a href="#" onclick="javascript:fillData('{{=it[i].sid}}')">承租人</a></td>
			<td>{{=it[i].name}}</td>
			<td>{{=it[i].tel}}</td>
		</tr>
	{{ } }}

	</tbody>
</table>	
</script>

<script type="text/javascript">

var frmDoc = null ;
var frmWin = null;
//模板初始化
function inItdotTemp(results){
	// 基本信息
	console.log(results);
	var userInfo = doT.template(document.getElementById('userInfo').text, undefined, null);
	document.getElementById('userInfoView').innerHTML = userInfo(results);
};

$(function (){
	 document.getElementById('testIfame').onload = function() {  // 当 iframe 页面被加载完成
		 		frmWin = window.top.document.getElementById("testIfame").contentWindow;
		 		frmDoc = window.top.document.getElementById("testIfame").contentWindow.document;
			    var script = frmDoc.createElement('script');
			    script.text='function queryNewMessage(){'+
			    	'var unreadMessageCount = 0;'+
			    	'var detail = \'{ "parameters.common":{ "mySite":"site","myPage":"\'+ myPage +\'","myPageID":"\'+ myPageId +\'"},"unread.message":{"userID":"\'+Whoami[\'userID.whoami\']+\'","userType":"\'+Whoami[\'userType.whoami\']+\'"}}\';'+
			     	'$.ajax({'+
			    		'url: __SERVICE_URL_PREFIX__+__SELECTDETAIL_URL__,'+
			    		'type:"post",'+
			    		'async: true,'+
			    		'dataType: "json",'+
			    		'data:\'detail=\'+ detail +\'&target=\','+
			    		'success: function(v) {'+
			    		 	'var data = v.data[0];'+
			    			'var wsData = eval(data[\'unread.message\']);'+
			    			'var logoutFlag = parseInt(wsData[\'logoutFlag\']);'+
			    			'if (logoutFlag == 1) {'+
			    				'swal({'+
			    					  'title: "我的提示",'+
			    					  'text: "登入已超时，请在右下角窗口重新登入！",'+
			    					  'timer: 2000,'+
			    					  'showConfirmButton: false'+
			    				'});'+
			    				'var MyIfame = window.top.document.getElementById("loginIfame");'+
			    				'if(MyIfame == null) {'+
			    					
				    				'var loginIfame = window.top.document.createElement("iframe");'+
				    				'loginIfame.src = \'https://fls-aflm.pingan.com.cn/pazl-web/app/login.html\';'+
				    				'loginIfame.height = \'500px\';'+
				    				'loginIfame.width = \'500px\';'+
				    				'loginIfame.id = \'loginIfame\';'+
				    				'window.top.document.getElementById("loginIfameView").append(loginIfame);'+
			    					
			    				'}'+
			    				'return;' +
			    			'}'+
			    		'}'+
			    	'});'+
			    '}';
			    script.type = 'text/javascript';
			    
			    // 插入的坐标
			    var scrs = window.top.document.getElementById("testIfame").contentWindow.document.getElementsByTagName('script');
			    var last = scrs[scrs.length - 1];
			    frmDoc.body.insertBefore(script,last);
			 	alert("Fill Success!");
     }
	 
	 // 注册查询事件
	$('#searchBtnID').on('click',function(){
		
		$.ajax({
	   	     type: 'POST',
	   	     url: 'http://vis.cdtsz.com/loansOrder/pluginList' ,
	   	     cache:false,
	   	     dataType: "json",
	   	  	 data: {'nameIsLike' : $('#queryNane').val(),'telIsLike' : $("#queryMobile").val()}, 
	   	     success: function(data){
	   	    	console.log(data);
	   	    	inItdotTemp(data.data);
	   		 },
		});
	});
	 
});

// 关闭登入窗口
function colseLoginIframe() {
	$("#loginIfameView").empty();
};

// 刷新平安页面
function refreshIframe () {
	document.getElementById('testIfame').contentWindow.location.reload(true);
};

//隐藏关闭
function onModel() {
	var modelFlag = $('#modelFlag').val(); // 1 是代表已打开，0是代表已关闭
	if(modelFlag == '1') {
		$('#modelFlag').val('0');
		$('#showDivID').hide();
	}else if(modelFlag == '0') {
		$('#modelFlag').val('1');
		$('#showDivID').show();
	}
};

// 调用城市事件方法
function InvokeCityEvent(provinceId,compareValue) {
	
	var options = frmDoc.getElementById(provinceId).options;
	for(var i in options) {
		if(options[i].text == compareValue) {
			options[i].selected = true;// 选中对应的城市值如 : 广东省
			
			// 手动触发下拉菜单值改变事件
			var evObje =  frmDoc.createEvent('HTMLEvents');
			evObje.initEvent('change',true,true);
			var provinceObj = frmDoc.getElementById(provinceId);
			provinceObj.dispatchEvent(evObje);
			break;
		}
	}
	
}

// 设置城市字段值
function setCityValue(cityId,compareValue) {
	var options = frmDoc.getElementById(cityId).options;
	
	for(var i in options) {
		if(options[i].text == compareValue) {
			options[i].selected = true;// 选中对应的城市值如 : 深圳市
			break;
		}
	}
}

// 填充方法
function fillData(orderSid) {
	$.ajax({
  	     type: 'POST',
  	     url: 'http://vis.cdtsz.com/plugin/get' ,
  	     cache:false,
  	  	 data: {'orderSid' : orderSid}, 
  	     dataType: "json",
  	     success: function(data){
  	    	
  	    	if(data.code != 1) {
  	    		alter("查询出错了!");
  	    		console.log("查询错误信息-------" + data);
  	    	}
			console.log(data.data);
			fillLoansUserInfo(data.data);
  		 },
	});
}

// 贷款用户信息
function fillLoansUserInfo(fileData) {
	
	
	// -- 基本信息
	var userInfo = fileData.user;
	frmDoc.getElementById("name").value = userInfo.name; // 姓名
	frmDoc.getElementById("cellphone").value = userInfo.tel; // 手机号码
	var $IDtype =  $(frmDoc.getElementById("IDtype")); // 证件类别
    var idTypeStr='身份证';
	if(userInfo.idtype == '2') {// VIS : 身份证
		$IDtype.val(1); // YX : 居民身份证
	}else if(userInfo.idtype == '2') {// VIS : 军官证
		$IDtype.val(5); // YX : 军人身份证
    }else if(userInfo.idtype == '3') {// VIS : 护照
		$IDtype.val(3); // YX : 护照 
    }else if(userInfo.idtype == '4') {// VIS : 士兵证
		$IDtype.val(6); // YX : 武装警察身份证
    }
	
	frmDoc.getElementById("IDnum").value = userInfo.idcard; // 身份证号码
	$(frmDoc.getElementById("driveType")).val('C1'); 		// 准驾车型 : 默认为 C1: 小型汽车
	
	frmDoc.getElementById("birthday").value = userInfo.birthdayString; // 生日
	
	var sexs = frmDoc.getElementsByName("sex"); // 性别
	for(var i in sexs) {
		if(userInfo.sex == 'M' && sexs[i].value == '1') {
			sexs[i].checked = true;
		}else if(userInfo.sex == 'F' && sexs[i].value == '2') {
			sexs[i].checked = true;
		}
	}
	
	// 婚姻状态
	if(userInfo.userAttrInfo.married == '0') { // 未婚
		frmDoc.getElementById("marriage").options[0].selected = true;
		frmWin.p033_onMarriage();// 调用加载函数
		// -- 直系亲属
		frmDoc.getElementById("parentname").value = userInfo.userAttrInfo.spouseName; // 直系亲属姓名
		frmDoc.getElementById("parentcellphone").value = userInfo.userAttrInfo.spouseTel; // 直系亲属手机号码
	}else {
		// 已婚
		frmDoc.getElementById("marriage").options[1].selected = true;
		frmWin.p033_onMarriage();// 调用加载函数
		// -- 直系亲属
		frmDoc.getElementById("spousename").value = userInfo.userAttrInfo.spouseName; // 配偶姓名
		frmDoc.getElementById("spousecellphone").value = userInfo.userAttrInfo.spouseTel; // 手机号码
		frmDoc.getElementById("spouseIDtype").options[0].selected = true;// 已婚配偶人证件类型 : 默认为居民身份证
		frmDoc.getElementById("spouseID").value = userInfo.userAttrInfo.spouseCardNo;
	}
	
	switch(userInfo.educationBackground) {
	case '1': // 小学及以下
	  frmDoc.getElementById("education").options[6].selected = true; // YX:  高中以下
	  break;
	case '2': // 初中
	  frmDoc.getElementById("education").options[6].selected = true; // YX:  高中以下
	  break;
	case '3': // 高中
	  frmDoc.getElementById("education").options[3].selected = true; // YX:  高中
	  break;
	case '4': // 中专
	  frmDoc.getElementById("education").options[4].selected = true; // YX:  中专
	  break;
	case '5': // 高职
	  frmDoc.getElementById("education").options[5].selected = true; // YX: 技校
	  break;
	case '6': // 专科
	  frmDoc.getElementById("education").options[2].selected = true;// YX: 专科
	  break;
	case '7': // 本科
	  frmDoc.getElementById("education").options[1].selected = true;// YX: 本科
	  break;
	case '8': // 硕士研究生
	  frmDoc.getElementById("education").options[0].selected = true; // YX: 本科以上
	  break;
	case '9': // 博士研究生及以上
	  $education.find("option[text='本科以上']").attr("selected",true);
	  frmDoc.getElementById("education").options[0].selected = true;
	  break;
	case '10': // 中等专业学校和中等技术学校
	  frmDoc.getElementById("education").options[5].selected = true;
	  break;
	case '11': // 文盲或半文盲
	  frmDoc.getElementById("education").options[6].selected = true;
	  break;
	case '12': // 技术学校
	  frmDoc.getElementById("education").options[5].selected = true;
	  break;
	default: // 其他
	  frmDoc.getElementById("education").options[6].selected = true;
	  break;
	}
	
	// 身份证省份
	InvokeCityEvent("homeprovince",fileData.hjProvince);
	// 身份证城市
	setCityValue("homecity",fileData.hjCity)
	// 身份证地址
	frmDoc.getElementById("homeaddress").value = userInfo.idaddress; 
	
	// 房产类型: 默认为自有无贷
	frmDoc.getElementById("estatetype").options[0].selected = true;
	
	// 现居住省份
	InvokeCityEvent("estateprovince",fileData.jzProvince);
	// 现居住城市
	setCityValue("estatecity",fileData.jzCity)
	// 现居住地址
	frmDoc.getElementById("estateaddress").value = userInfo.address; 
	
	// frmDoc.getElementById("bankcard").value = 缺少银行卡号 
	
	var works = frmDoc.getElementsByName("work"); // 有无工作
	for(var i in works) {
		if(userInfo.userAttrInfo.workUnit != null && userInfo.userAttrInfo.workUnit != '' && works[i].value == '1') {
			works[i].checked = true;
		}else if(userInfo.userAttrInfo.workUnit == null && userInfo.userAttrInfo.workUnit == '' && works[i].value == '2') {
			sexs[i].checked = true;
		}
	}
	
	// frmDoc.getElementById("familyincome").value =  缺少每月家庭净收入
	
	// frmDoc.getElementById("familyexpend").value =  缺少月平均支出
	
	// frmDoc.getElementsByName("isfirstbuy"))  缺少是否首次为家庭购车 : 单选项
	
	// 购车目的 : 下拉框（写死）
	frmDoc.getElementById("buypurpose").options[0].selected = true;
	   
	// frmDoc.getElementById("comment").value = 缺少备注 ： 大文本框
	
	
	// -- 工作单位
	
	frmDoc.getElementById("empname").value = userInfo.userAttrInfo.workUnit; // 单位名称
	
	// frmDoc.getElementById("workyear").value = 缺少工作年限
	
	// 单位省份
	InvokeCityEvent("empprovince",fileData.dwProvince);
	// 单位城市
	setCityValue("empcity",fileData.dwCity)
	// 单位详细地址
	frmDoc.getElementById("empaddress").value = userInfo.userAttrInfo.workAdress; 
	
	frmDoc.getElementById("empphone").value = userInfo.userAttrInfo.workTel; // 单位电话
	
	frmDoc.getElementById("emptype").options[7].selected = true; // 企业性质 : 默认其他
	
	frmDoc.getElementById("empoccupation").options[18].selected = true; // 职业 : 默认非上述企业的领薪人士
	
	// -- 紧急联系人
	frmDoc.getElementById("emgconname").value = userInfo.userAttrInfo.assist1Linkman; // YX : 紧急联系人 = VIS :辅助联系人 - 亲属关系 
	frmDoc.getElementById("emgconrelation").options[0].selected = true;	// 默认填写亲属
	
	frmDoc.getElementById("emgconcellphone").value = userInfo.userAttrInfo.assist1phone; // YX : 紧急联系人手机号码 
	
}
</script>

</html>
